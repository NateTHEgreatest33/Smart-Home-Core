
/*********************************************************************
*
*   NAME:
*       background_task.cpp
*
*   DESCRIPTION:
*       background task
*
*   Copyright 2024 Nate Lenze
*
*********************************************************************/

/*--------------------------------------------------------------------
                              INCLUDES
--------------------------------------------------------------------*/
#include "background_task.hpp"
#include "console.hpp"
#include "mailbox.hpp"

/*--------------------------------------------------------------------
                          GLOBAL NAMESPACES
--------------------------------------------------------------------*/

/*--------------------------------------------------------------------
                          LITERAL CONSTANTS
--------------------------------------------------------------------*/

/*--------------------------------------------------------------------
                                TYPES
--------------------------------------------------------------------*/

/*--------------------------------------------------------------------
                           MEMORY CONSTANTS
--------------------------------------------------------------------*/

/*--------------------------------------------------------------------
                              VARIABLES
--------------------------------------------------------------------*/

/*--------------------------------------------------------------------
                              EXTERNS
--------------------------------------------------------------------*/
extern core::console Console;
extern core::mailbox< (size_t)mbx_index::NUM_MAILBOX > Mailbox;

/*--------------------------------------------------------------------
                                MACROS
--------------------------------------------------------------------*/

/*--------------------------------------------------------------------
                              PROCEDURES
--------------------------------------------------------------------*/

/*********************************************************************
*
*   PROCEDURE NAME:
*       background_task
*
*   DESCRIPTION:
*       background process
*
*********************************************************************/
void background_task
    (
    void
    )
{
/*----------------------------------------------------------
Local Variables
----------------------------------------------------------*/
static absolute_time_t s_current_100ms_timeout = delayed_by_ms( get_absolute_time(), 100 );

/*----------------------------------------------------------
Main Loop
----------------------------------------------------------*/
while( true )
    {
    /*------------------------------------------------------
    Run console periodic
    ------------------------------------------------------*/
    Console.console_runtime();

    /*------------------------------------------------------
    Run mailbox rx periodic
    ------------------------------------------------------*/
    Mailbox.rx_runtime();

    /*------------------------------------------------------
    Run mailbox tx periodic every 100ms & update timeout
    after a run
    ------------------------------------------------------*/
    if( s_current_100ms_timeout < get_absolute_time() )
        {
        Mailbox.tx_runtime();
        s_current_100ms_timeout = delayed_by_ms( get_absolute_time(), 100 );
        }
        
    }
}